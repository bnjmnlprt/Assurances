<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Assurances - Helexia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-sortable th { cursor: pointer; }
        .table-sortable th:hover { background-color: #f0f4f8; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .status-badge {
            padding: 0.25em 0.6em;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 9999px;
        }
        .status-en-cours { background-color: #FEF3C7; color: #92400E; }
        .status-standby { background-color: #DBEAFE; color: #1E40AF; }
        .status-clos { background-color: #D1FAE5; color: #065F46; }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="offline-banner" class="hidden bg-yellow-500 text-white text-center p-2 text-sm">
        ⚠️ Mode hors ligne : Les modifications ne sont pas partagées en temps réel.
    </div>

    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <img src="https://www.helexia.green/wp-content/uploads/2023/12/helexia-logo-header.svg" alt="Helexia Logo" class="h-8 w-auto">
                        <h1 class="text-xl font-semibold text-gray-900">Gestion des Sinistres</h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <div id="app-content">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold tracking-tight text-gray-900">Suivi des Sinistres</h2>
                        <button id="addClaimBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>Nouveau Sinistre
                        </button>
                    </div>
                    <div class="relative mt-3 md:mt-0">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-gray-400"></i></div>
                        <input type="text" id="searchInput" class="block w-full md:w-80 pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Rechercher un sinistre...">
                    </div>
                </div>
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 table-sortable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="projet">Projet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="spv">SPV</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="dateSinistre">Date Sinistre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="dateDernierSuivi">Dernier Suivi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="statut">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="montantDevis">Montant Devis</th>
                                </tr>
                            </thead>
                            <tbody id="claimsTableBody" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="text-center py-10"><div class="spinner mx-auto"></div><p class="mt-2 text-sm text-gray-500">Connexion en cours...</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALE SINISTRE -->
    <div id="claimModal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold" id="modalTitle"></h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto"></div>
            <div id="modalFooter" class="p-4 bg-gray-50 border-t flex justify-end space-x-3"></div>
        </div>
    </div>
    
    <script type="module">
        // =================================================================================
        // --- SECTION FIREBASE ---
        // =================================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth, claimsCollectionRef;
        let isOnlineMode = false;

        // =================================================================================
        // --- SECTION DONNÉES ---
        // =================================================================================

        const initialClaimsData = [
            { projet: "DI 143", spv: "HELEXIA SOLAR 8", adresse: "Lieu-dit Champ de Loraud\n16140 Lupsault", dateSinistre: "2022-04-08", categorie: "Intempéries", sinistre: "1er \"sinistre\" : litige lié à la structure : Côté juridique - expertise judiciaire\n2ème sinistre : détachement d'une partie métallique", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "VERING", dateExpertise: null, refExpert: "22VTB2892", refAssureur: "", statut: "EN COURS", suivi: "Attente rapport des experts (1er et 2ème sinistre)\nL'expert Vering attend un devis pour les réparation - en attendant : Standby de son côté\n21.10.2022 : Retour de l'expert (M. Buchet Vering)\nVent < 110km/h (minimum pour qualifier en tempête) => La responsabilité pour la remise en état du bardage et de la faitière revient au constructeur (décennale)\n09.11.2022 : En attente du chiffrage Prosolia", dateDernierSuivi: null },
            { projet: "DI 300 DEBARRE", spv: "HELEXIA SOLAR 12", adresse: "Pèterenard\n86210 Archigny", dateSinistre: "2022-08-02", categorie: "Incendie", sinistre: "Incendie", contrat: "MPV", montantDevis: 64319.05, montantFranchise: null, remboursement: null, expert: "Polyexpert", dateExpertise: null, refExpert: "", refAssureur: "410191563-000006", statut: "EN COURS", suivi: "02.08.2022 : Déclaration du sinistre\n08.08.2022 : Accusé de réception de la déclaration\n09.08.2022 : Mandatement de l'expert Polyexpert\n12.08.2022 : Réception du rapport préliminaire de l'expert\n15.09.2022 : Expertise sur site\n23.09.2022 : Réception du rapport d'expertise définitif\n28.09.2022 : Accord de l'assureur pour le règlement\n10.10.2022 : Règlement reçu", dateDernierSuivi: null },
            { projet: "DI043B", spv: "Helexia Solar 9", adresse: "Lieu-dit Grelet\n82150 Montaigu de Quecy", dateSinistre: null, categorie: "", sinistre: "Pigeons morts + insalubrité toiture", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "BOURG PARK 1", spv: "BOURG PARK", adresse: "Chanelette\n07700 Bourg St Andéol", dateSinistre: "2023-12-22", categorie: "", sinistre: "Choc VTM", contrat: "MPV", montantDevis: 4680, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "Déclaration faite, en attente retour assureur", dateDernierSuivi: null },
            { projet: "002963_ARFR_BLOIS-VINEUIL", spv: "HELEXIA SOLAR 15", adresse: "99 rue Pierre Gilles de Gennes\n41350 Vineuil", dateSinistre: "2024-06-22", categorie: "", sinistre: "Choc ombrières", contrat: "MPV", montantDevis: 8056.34, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "En attente de devis", dateDernierSuivi: null },
            { projet: "HELIOCIANA - Montpellier", spv: "HELIO CIANA", adresse: "Route de Ganges\nMontpelier 34000", dateSinistre: "2024-06-20", categorie: "", sinistre: "Panneaux cassés", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "Expertise en cours", dateDernierSuivi: null },
            { projet: "HELIOC_4975-KS_07_Narbonne SM", spv: "HELIO CIANA", adresse: "Avenue du Général Leclerc", dateSinistre: "2024-06-20", categorie: "", sinistre: "Panneaux cassés", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "008697_CMC", spv: "Helexia Dev", adresse: "ZAC les Manteaux\n41350 Vineuil", dateSinistre: null, categorie: "", sinistre: "45 panneaux cassés, sinistre à déclarer - Problème de qualité. Pas de déclaration - Réclamation SPA à faire à Amarenco - 300 panneaux", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "002963_ARFR_Blois Vineuil", spv: "HELEXIA SOLAR 15", adresse: "99 rue Pierre Gilles de Gennes\n41350 Vineuil", dateSinistre: null, categorie: "", sinistre: "45 panneaux cassés, sinistre à déclarer - Problème de qualité. Pas de déclaration - Réclamation SPA à faire à Amarenco - 300 panneaux", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "FERME PV16", spv: "FERME PV16", adresse: "Lieu-dit Les Bourbouraux \n13630 Eyragues", dateSinistre: null, categorie: "", sinistre: "Problématique de panneaux - Amarenco a réglé 15k€ et responsabilité à HLX. Trop de délai entre la réparation et la nouvelle évaluation est à 30k€. Intervention urgente effectuée - travaux fait", contrat: "MPV", montantDevis: 30000, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "AU01", spv: "MIROIR DU SOLEIL", adresse: "Aushopping Les Trois Rivières", dateSinistre: "2025-06-26", categorie: "Modules", sinistre: "Impacts de grêle", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "Attente", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "Parc à Bétail 1 & 2 - 4862/4866", spv: "EV25", adresse: "Port de Sète\n34200 Sète", dateSinistre: "2025-06-06", categorie: "Élect", sinistre: "Connecteurs défectueux qui ont causé un léger incendie et endommagé la Centrale et le bac acier. Tous les modules et les connecteurs ont été endommagés et devront être remplacés.", contrat: "MPV", montantDevis: 45000, montantFranchise: null, remboursement: null, expert: "Attente", dateExpertise: null, refExpert: "", refAssureur: "ER2503526", statut: "EN COURS", suivi: "", dateDernierSuivi: null },
            { projet: "2143 - Dronne & Belle", spv: "AFD10", adresse: "5 Pl. de la Jeunesse, 24310 Brantôme", dateSinistre: "2025-08-05", categorie: "Élect", sinistre: "Bilan:\n-13 modules photovoltaiques Canadian\nSolar\n-Le système d'intégration pour 20 modules\n-On a pu sauver 7 modules qui n'ont pas été touchés par le feu;\n-Le câblage des strings et mise a la terre est a refaire sur la même surface.\n-On a mis en sécurité les modules PV et on a débranché tous les strings de côté onduleurs;\n-Suite a l'incendie, le local technique est à refaire.", contrat: "MPV", montantDevis: 30000, montantFranchise: null, remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "Analyse interne pour déterminer la responsabilité avant déclaration.", dateDernierSuivi: null }
        ];

        let claimsData = []; // Ce tableau contiendra les données en temps réel de Firestore

        // =================================================================================
        // --- SECTION CONFIGURATION & ÉTAT ---
        // =================================================================================

        const claimsTableBody = document.getElementById('claimsTableBody'), searchInput = document.getElementById('searchInput');
        const claimModal = document.getElementById('claimModal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), modalFooter = document.getElementById('modalFooter');
        
        let currentSort = { column: 'dateSinistre', direction: 'desc' };

        // =================================================================================
        // --- SECTION UTILITAIRES ---
        // =================================================================================
        
        const formatCurrency = (amount) => (amount === null || amount === undefined || isNaN(amount)) ? 'N/A' : new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        const formatDate = (dateString) => {
            if (!dateString || dateString === '-') return '';
            try { return new Date(dateString).toISOString().split('T')[0]; } 
            catch (e) { return ''; }
        };
        const displayDate = (dateString) => {
            if (!dateString || dateString === '-') return 'N/A';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', { timeZone: 'UTC' });
            } catch (e) { return dateString; }
        };
        const createStatusBadge = (status) => {
            const lowerStatus = (status || '').toLowerCase().replace(/\s/g, '-');
            return `<span class="status-badge status-${lowerStatus}">${status}</span>`;
        }

        // =================================================================================
        // --- SECTION AFFICHAGE ---
        // =================================================================================

        const renderClaimsTable = (data) => {
            claimsTableBody.innerHTML = data.length === 0 ? `<tr><td colspan="6" class="text-center py-10 text-gray-500">Aucun sinistre trouvé.</td></tr>` : '';
            data.forEach(claim => {
                const row = claimsTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${claim.projet}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${claim.spv || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate(claim.dateSinistre)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate(claim.dateDernierSuivi)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${createStatusBadge(claim.statut)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(claim.montantDevis)}</td>`;
                row.onclick = () => openClaimModal(claim.id);
            });
        };

        // =================================================================================
        // --- SECTION LOGIQUE PRINCIPALE ---
        // =================================================================================

        const filterAndRenderClaims = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredData = claimsData.filter(claim => 
                Object.values(claim).some(val => 
                    String(val).toLowerCase().includes(searchTerm)
                )
            );
            sortAndRender(filteredData);
        };

        const sortAndRender = (data) => {
            data.sort((a, b) => {
                let valA = a[currentSort.column], valB = b[currentSort.column];
                if ((currentSort.column).includes('date')) { 
                    valA = valA ? new Date(valA).getTime() : 0;
                    valB = valB ? new Date(valB).getTime() : 0;
                } else if (typeof valA === 'string') {
                    valA = (valA || '').toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            renderClaimsTable(data);
        };

        const setSortColumn = (column) => {
            const direction = (currentSort.column === column && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { column, direction };
            filterAndRenderClaims();
        };

        const addNewClaim = async () => {
             const newClaimData = {
                projet: "Nouveau Sinistre", spv: "", adresse: "", dateSinistre: new Date().toISOString().split('T')[0],
                categorie: "", sinistre: "", contrat: "MPV", montantDevis: null, montantFranchise: null,
                remboursement: null, expert: "", dateExpertise: null, refExpert: "", refAssureur: "",
                statut: "EN COURS", suivi: "", dateDernierSuivi: null
            };

            if (isOnlineMode) {
                try {
                    const docRef = await addDoc(claimsCollectionRef, newClaimData);
                    openClaimModal(docRef.id, true);
                } catch (error) {
                    console.error("Erreur (Firebase) lors de l'ajout du sinistre: ", error);
                }
            } else {
                const newId = `local_${new Date().getTime()}`;
                claimsData.unshift({ id: newId, ...newClaimData });
                localStorage.setItem('claimsDataHelexia', JSON.stringify(claimsData));
                filterAndRenderClaims();
                openClaimModal(newId, true);
            }
        };

        // =================================================================================
        // --- SECTION MODALES ---
        // =================================================================================

        const openClaimModal = (claimId, isEditMode = false) => {
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            modalTitle.textContent = isEditMode ? `Édition: ${claim.projet}` : `Détails: ${claim.projet}`;
            if (isEditMode) renderClaimEditView(claim);
            else renderClaimDetailView(claim);
            claimModal.classList.add('active');
        };

        const renderClaimDetailView = (claim) => {
            modalBody.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                <div class="md:col-span-2 p-4 bg-gray-50 rounded-md"><h4 class="font-semibold text-gray-700 mb-1">Description</h4><p class="text-gray-600 whitespace-pre-wrap">${claim.sinistre || 'N/A'}</p></div>
                <div><span class="font-semibold text-gray-500">SPV:</span> ${claim.spv || 'N/A'}</div>
                <div><span class="font-semibold text-gray-500">Adresse:</span> ${claim.adresse || 'N/A'}</div>
                <div><span class="font-semibold text-gray-500">Date sinistre:</span> ${displayDate(claim.dateSinistre)}</div>
                <div><span class="font-semibold text-gray-500">Statut:</span> ${createStatusBadge(claim.statut)}</div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-gray-700 mb-2">Finances</h4></div>
                <div><span class="font-semibold text-gray-500">Montant Devis:</span> ${formatCurrency(claim.montantDevis)}</div>
                <div><span class="font-semibold text-gray-500">Franchise:</span> ${formatCurrency(claim.montantFranchise)}</div>
                <div><span class="font-semibold text-gray-500">Remboursement:</span> ${formatCurrency(claim.remboursement)}</div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-gray-700 mb-2">Expertise & Suivi</h4></div>
                <div><span class="font-semibold text-gray-500">Expert:</span> ${claim.expert || 'N/A'}</div>
                <div><span class="font-semibold text-gray-500">Date expertise:</span> ${displayDate(claim.dateExpertise)}</div>
                <div><span class="font-semibold text-gray-500">Date dernier suivi:</span> ${displayDate(claim.dateDernierSuivi)}</div>
                <div><span class="font-semibold text-gray-500">Réf. Assureur:</span> ${claim.refAssureur || 'N/A'}</div>
                <div class="md:col-span-2 p-4 bg-blue-50 rounded-md mt-4"><h4 class="font-semibold text-gray-700 mb-1">Détails du Suivi</h4><p class="text-gray-600 whitespace-pre-wrap">${claim.suivi || 'Aucun'}</p></div>
            </div>`;
            modalFooter.innerHTML = `<button id="editClaimBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">Éditer le dossier</button>
                                   <button class="footer-close-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">Fermer</button>`;
            modalFooter.querySelector('.footer-close-btn').onclick = () => closeModal(claimModal);
            document.getElementById('editClaimBtn').onclick = () => openClaimModal(claim.id, true);
        };

        const renderClaimEditView = (claim) => {
            modalBody.innerHTML = `<form id="editClaimForm" class="space-y-4 text-sm">
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">Projet</label><input type="text" name="projet" value="${claim.projet || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">SPV</label><input type="text" name="spv" value="${claim.spv || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                <div><label class="block font-medium">Adresse</label><textarea name="adresse" rows="2" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${claim.adresse || ''}</textarea></div>
                <div><label class="block font-medium">Description</label><textarea name="sinistre" rows="3" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${claim.sinistre || ''}</textarea></div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">Date Sinistre</label><input type="date" name="dateSinistre" value="${formatDate(claim.dateSinistre)}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">Statut</label><select name="statut" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"><option ${claim.statut === 'EN COURS' ? 'selected' : ''}>EN COURS</option><option ${claim.statut === 'STANDBY' ? 'selected' : ''}>STANDBY</option><option ${claim.statut === 'CLOS' ? 'selected' : ''}>CLOS</option></select></div>
                </div>
                <div class="grid md:grid-cols-3 gap-4 border-t pt-4">
                    <div><label class="block font-medium">Montant Devis (€)</label><input type="number" step="0.01" name="montantDevis" value="${claim.montantDevis || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">Franchise (€)</label><input type="number" step="0.01" name="montantFranchise" value="${claim.montantFranchise || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">Remboursement (€)</label><input type="number" step="0.01" name="remboursement" value="${claim.remboursement || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                <div class="grid md:grid-cols-3 gap-4 border-t pt-4">
                    <div><label class="block font-medium">Expert</label><input type="text" name="expert" value="${claim.expert || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">Date Expertise</label><input type="date" name="dateExpertise" value="${formatDate(claim.dateExpertise)}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">Date dernier suivi</label><input type="date" name="dateDernierSuivi" value="${formatDate(claim.dateDernierSuivi)}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                 <div class="grid md:grid-cols-1 gap-4 border-t pt-4">
                    <div><label class="block font-medium">Réf. Assureur</label><input type="text" name="refAssureur" value="${claim.refAssureur || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                <div class="border-t pt-4"><label class="block font-medium">Suivi</label><textarea name="suivi" rows="3" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${claim.suivi || ''}</textarea></div>
            </form>`;
            modalFooter.innerHTML = `<button id="saveClaimBtn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">Sauvegarder</button>
                                   <button id="deleteClaimBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium">Supprimer</button>
                                   <button id="cancelEditBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">Annuler</button>`;
            document.getElementById('saveClaimBtn').onclick = () => saveClaimChanges(claim.id);
            document.getElementById('deleteClaimBtn').onclick = () => deleteClaim(claim.id);
            document.getElementById('cancelEditBtn').onclick = () => openClaimModal(claim.id, false);
        };

        const saveClaimChanges = async (claimId) => {
            const form = document.getElementById('editClaimForm');
            const formData = new FormData(form);
            
            const updatedData = {};
            for (const key of formData.keys()) {
                const value = formData.get(key);
                if (['montantDevis', 'montantFranchise', 'remboursement'].includes(key)) {
                    updatedData[key] = value ? parseFloat(value) : null;
                } else {
                    updatedData[key] = value;
                }
            }

            if (isOnlineMode) {
                const claimDocRef = doc(db, `/artifacts/${appId}/public/data/sinistres`, claimId);
                try {
                    await setDoc(claimDocRef, updatedData, { merge: true });
                } catch (error) {
                    console.error("Erreur de sauvegarde (Firebase): ", error);
                }
            } else {
                const claimIndex = claimsData.findIndex(c => c.id === claimId);
                if (claimIndex !== -1) {
                    claimsData[claimIndex] = { ...claimsData[claimIndex], ...updatedData };
                    localStorage.setItem('claimsDataHelexia', JSON.stringify(claimsData));
                    filterAndRenderClaims();
                }
            }
            closeModal(claimModal);
        };

        const deleteClaim = async (claimId) => {
            console.log(`Pour confirmer la suppression, tapez "confirmDelete()" dans la console.`);
            window.confirmDelete = async () => {
                if (isOnlineMode) {
                     try {
                        await deleteDoc(doc(db, `/artifacts/${appId}/public/data/sinistres`, claimId));
                        closeModal(claimModal);
                        console.log("Sinistre supprimé (Firebase).");
                    } catch (error) {
                        console.error("Erreur de suppression (Firebase): ", error);
                    }
                } else {
                    claimsData = claimsData.filter(c => c.id !== claimId);
                    localStorage.setItem('claimsDataHelexia', JSON.stringify(claimsData));
                    filterAndRenderClaims();
                    closeModal(claimModal);
                    console.log("Sinistre supprimé (Local).");
                }
                delete window.confirmDelete;
            };
        };

        const closeModal = (modal) => modal.classList.remove('active');

        // =================================================================================
        // --- SECTION INITIALISATION & AUTHENTIFICATION ---
        // =================================================================================

        const initializeOfflineMode = () => {
            console.log("Démarrage en mode hors ligne.");
            isOnlineMode = false;
            document.getElementById('offline-banner').classList.remove('hidden');
            claimsData = JSON.parse(localStorage.getItem('claimsDataHelexia')) || initialClaimsData.map((d, i) => ({...d, id: `local_${i}`}));
            filterAndRenderClaims();
        };

        const setupFirestoreListener = () => {
             onSnapshot(claimsCollectionRef, async (snapshot) => {
                if (snapshot.empty && initialClaimsData.length > 0) {
                    console.log("Base de données vide. Initialisation avec les données par défaut.");
                    const batch = writeBatch(db);
                    initialClaimsData.forEach(claimData => {
                        const newDocRef = doc(claimsCollectionRef);
                        batch.set(newDocRef, claimData);
                    });
                    await batch.commit();
                } else {
                    claimsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    filterAndRenderClaims();
                }
            }, (error) => {
                console.error("Erreur de lecture des données, passage en mode hors ligne: ", error);
                initializeOfflineMode();
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'helexia-sinistres-app';
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (!firebaseConfig) {
                initializeOfflineMode();
            } else {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                claimsCollectionRef = collection(db, `/artifacts/${appId}/public/data/sinistres`);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Authentification réussie. Mise en place de l'écouteur Firestore.");
                        isOnlineMode = true;
                        setupFirestoreListener();
                    }
                });

                const authenticate = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("L'authentification Firebase a échoué. Passage en mode hors ligne.", error);
                        initializeOfflineMode();
                    }
                };
                authenticate();
            }
            
            document.getElementById('addClaimBtn').onclick = addNewClaim;
            searchInput.addEventListener('keyup', filterAndRenderClaims);
            document.querySelectorAll('.table-sortable th').forEach(h => h.onclick = () => setSortColumn(h.dataset.sort));
            document.querySelectorAll('.close-modal-btn').forEach(btn => btn.onclick = () => closeModal(claimModal));
            
            claimModal.onclick = (e) => { if (e.target === claimModal) closeModal(claimModal); };
            claimModal.querySelector('.modal-content').addEventListener('click', (e) => e.stopPropagation());
        });
    </script>
</body>
</html>
