<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Assurances - Helexia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .table-sortable th { cursor: pointer; }
        .table-sortable th:hover { background-color: #f0f4f8; }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.active .modal-content { transform: scale(1); }
        .nav-link {
            padding: 8px 16px; border-radius: 6px; font-weight: 500;
            color: #4B5563; transition: background-color 0.2s, color 0.2s;
            border-bottom: 2px solid transparent;
        }
        .nav-link:hover { background-color: #F3F4F6; }
        .nav-link.active { color: #4338CA; border-bottom-color: #4F46E5; }
        [data-page] { display: none; }
        [data-page].active { display: block; }
        .year-btn {
            padding: 6px 12px; border-radius: 6px; font-weight: 500;
            background-color: #F3F4F6; color: #4B5563;
            border: 1px solid #E5E7EB;
        }
        .year-btn.active {
            background-color: #4F46E5; color: white; border-color: #4F46E5;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="min-h-screen flex flex-col">
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <svg class="h-8 w-auto text-indigo-600" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 20h2a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2"></path><path d="M12 2v2"></path><path d="M4 10V8a2 2 0 0 1 2-2h2"></path><path d="M12 16v-1a2 2 0 0 1 2-2h2a2 2 0 0 0 2-2V8"></path><path d="M12 22v-2"></path><path d="M20 12h2"></path><path d="M2 12h2"></path><path d="m18 16-2-2"></path><path d="m6 8-2 2"></path><path d="m6 16 2-2"></path><path d="m18 8 2 2"></path></svg>
                        <h1 class="text-xl font-semibold text-gray-900">Gestion Assurances Helexia</h1>
                    </div>
                </div>
            </div>
            <nav class="bg-white border-t border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex space-x-2">
                        <a href="#" class="nav-link active" data-target="sinistres">Suivi des Sinistres</a>
                        <a href="#" class="nav-link" data-target="contracts">Contrats</a>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- PAGE: SUIVI DES SINISTRES -->
            <div data-page="sinistres" class="active">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4">
                    <h2 class="text-2xl font-bold tracking-tight text-gray-900">Suivi des Sinistres</h2>
                    <div class="relative mt-3 md:mt-0">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="h-5 w-5 text-gray-400"></i></div>
                        <input type="text" id="searchInput" class="block w-full md:w-80 pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Rechercher un sinistre...">
                    </div>
                </div>
                <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 table-sortable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="projet">Projet</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="spv">SPV</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="dateSinistre">Date Sinistre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="statut">Statut</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-sort="montantDevis">Montant Devis</th>
                                </tr>
                            </thead>
                            <tbody id="claimsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PAGE: CONTRATS -->
            <div data-page="contracts">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-2xl font-bold tracking-tight text-gray-900">Contrats d'Assurance</h2>
                        <div class="flex items-center space-x-2">
                             <button class="year-btn active" data-year="2024">2024</button>
                             <button class="year-btn" data-year="2025">2025</button>
                             <button class="year-btn" data-year="2026">2026</button>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 text-center">
                        <p class="text-sm font-medium text-gray-500">Coût Annuel Total des Primes</p>
                        <p id="total-premium" class="text-2xl font-bold text-indigo-600">0,00 €</p>
                    </div>
                </div>
                 <div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom de l'assurance</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assureur</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">N° Police</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prime Annuelle TTC</th>
                                </tr>
                            </thead>
                            <tbody id="contractsTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALE SINISTRE -->
    <div id="claimModal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold" id="modalTitle"></h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="modalBody" class="p-6 overflow-y-auto"></div>
            <div id="modalFooter" class="p-4 bg-gray-50 border-t flex justify-end space-x-3"></div>
        </div>
    </div>

    <!-- MODALE CONTRAT -->
    <div id="contractModal" class="modal-backdrop">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl m-4 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-lg font-semibold" id="contractModalTitle"></h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-600"><i data-lucide="x" class="h-6 w-6"></i></button>
            </div>
            <div id="contractModalBody" class="p-6 overflow-y-auto"></div>
            <div class="p-4 bg-gray-50 border-t flex justify-end">
                <button class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // --- DONNÉES ---
        const claimsData = [
            { id: 1, projet: "IM11 SEMECOURT", spv: "SOLEILIMMO", adresse: "Rue du pré des Meuniers 59170 Semecourt/Feves", dateSinistre: "2020-07-10", categorie: "Bris machine", sinistre: "armoire AC carbonisé : arrêt total de la centale - perte exploitation", contrat: "MPV", montantDevis: 4563.93, montantFranchise: 507.1, remboursement: 4056.83, expert: "-", dateExpertise: "2020-07-15", refExpert: "", refAssureur: "", statut: "CLOS", suivi: "" },
            { id: 2, projet: "EXT05 VEOLIA", spv: "HELEXIA SOLAR 5", adresse: "Lieu-dit Collert de Grisella 62000 Nice", dateSinistre: "2020-05-12", categorie: "Bris machine", sinistre: "disjoncteur BT principal de l’installation est HS et cause un arrêt total du site", contrat: "MPV", montantDevis: 7004.57, montantFranchise: 1881.98, remboursement: 5122.59, expert: "-", dateExpertise: "", refExpert: "", refAssureur: "", statut: "CLOS", suivi: "" },
            { id: 3, projet: "AGS48 PASCALIN", spv: "ALTER GRAND SUD", adresse: "161 Route de L'Henrion 48130 Aumont-Aubrac", dateSinistre: "2020-06-30", categorie: "Incendie", sinistre: "Hangar totalement détruit - incendie", contrat: "MPV", montantDevis: 88587.86, montantFranchise: 7500, remboursement: 102150.75, expert: "Polyexpert", dateExpertise: "2020-07-07", refExpert: "2020LYO000", refAssureur: "410191563-000001", statut: "CLOS", suivi: "Indemnités versées" },
            { id: 4, projet: "FR_124_0001_VOL", spv: "VOL-V", adresse: "Lieu dit La Borie Haute 12290 Ségur", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000009", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 5, projet: "Parc à Bétail 1 & 2", spv: "EV25", adresse: "Port de Sète", dateSinistre: "2025-06-06", categorie: "Électrique", sinistre: "Connecteurs défectueux qui ont causé un léger incendie.", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "Attente", dateExpertise: "", refExpert: "", refAssureur: "ER2503526", statut: "EN COURS", suivi: "Attente devis de réparation." },
            { id: 6, projet: "2143 - Dronne & Belle", spv: "AFD10", adresse: "5 Pl. de la Jeunesse, 24310 Brantôme", dateSinistre: "2025-08-05", categorie: "Électrique", sinistre: "Incendie local technique, 13 modules détruits.", contrat: "MPV", montantDevis: 30000, montantFranchise: null, remboursement: null, expert: "", dateExpertise: "", refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "Analyse interne pour déterminer la responsabilité avant déclaration." },
            { id: 7, projet: "AU01", spv: "MIROIR DU SOLEIL", adresse: "Aushopping Les Trois Rivières", dateSinistre: "2025-06-26", categorie: "Modules", sinistre: "Impacts de grêle", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "Attente", dateExpertise: "", refExpert: "", refAssureur: "", statut: "EN COURS", suivi: "Attente du rapport d'expertise." },
            { id: 8, projet: "AGS48 PASCALIN", spv: "ALTER GRAND SUD", adresse: "161 Route de L'Henrion 48130 Aumont-Aubrac", dateSinistre: "2021-03-24", categorie: "Bris machine", sinistre: "Arrêt de la centrale suite à un défaut onduleur", contrat: "MPV", montantDevis: 21258.83, montantFranchise: 465.94, remboursement: 21062.89, expert: "-", dateExpertise: "", refExpert: "", refAssureur: "410191563-000001", statut: "CLOS", suivi: "" },
            { id: 9, projet: "IM03 - LIDL", spv: "LIDL", adresse: "LIDL Montluçon", dateSinistre: "2022-06-04", categorie: "Climatique", sinistre: "Orage de grêle", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "Polyexpert", dateExpertise: "2022-06-22", refExpert: "", refAssureur: "410191563-000004", statut: "CLOS", suivi: "Pas de prise en charge - pas de dommage" },
            { id: 10, projet: "FR_018_0001_VOL", spv: "VOL-V", adresse: "Lieu dit Les Effeuilles 18210 Charenton du Cher", dateSinistre: "2022-08-20", categorie: "Vol", sinistre: "Vol de 112 modules", contrat: "MPV", montantDevis: 46000, montantFranchise: 5000, remboursement: 41000, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000005", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 11, projet: "FR_082_0001_VOL", spv: "VOL-V", adresse: "Lieu dit Jean de L'étang 82100 Castel Sarrazin", dateSinistre: "2022-12-05", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000007", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 12, projet: "FR_047_0001_VOL", spv: "VOL-V", adresse: "Lieu dit Au Tira 47150 Paulhiac", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000008", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 13, projet: "FR_012_0001_VOL", spv: "VOL-V", adresse: "Lieu dit Le sot de la Nauze 12290 Ségur", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000010", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 14, projet: "FR_012_0002_VOL", spv: "VOL-V", adresse: "Lieu dit La Borie Haute 12290 Ségur", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000011", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 15, projet: "FR_082_0002_VOL", spv: "VOL-V", adresse: "Lieu dit Jean de L'étang 82100 Castel Sarrazin", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000012", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 16, projet: "FR_018_0002_VOL", spv: "VOL-V", adresse: "Lieu dit Les Effeuilles 18210 Charenton du Cher", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000013", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 17, projet: "FR_047_0002_VOL", spv: "VOL-V", adresse: "Lieu dit Au Tira 47150 Paulhiac", dateSinistre: "2023-01-20", categorie: "Vol", sinistre: "Vol de 44 modules", contrat: "MPV", montantDevis: 21500, montantFranchise: 5000, remboursement: 16500, expert: "Expertise à distance", dateExpertise: "", refExpert: "", refAssureur: "410191563-000014", statut: "CLOS", suivi: "Remboursement reçu" },
            { id: 18, projet: "IM01 - CARREFOUR", spv: "CARREFOUR", adresse: "Carrefour Wasquehal", dateSinistre: "2023-07-06", categorie: "Bris machine", sinistre: "Infiltration d'eau dans le TGBT", contrat: "MPV", montantDevis: null, montantFranchise: null, remboursement: null, expert: "Polyexpert", dateExpertise: "2023-07-13", refExpert: "", refAssureur: "410191563-000015", statut: "CLOS", suivi: "Pas de prise en charge - défaut d'entretien" }
        ];
        const contractsData = [
            { id: 1, businessLine: "IPP/EPC", nomAssurance: "MSIG TRC Tout Risques Chantier", description: "Construction, essais, et mise en service de centrales photovoltaïques", montantGaranties: "20,000,000 € par sinistre", details: "Essentielle pour couvrir les risques associés à la construction de nouvelles installations, garantissant la protection financière contre les dommages matériels ou pertes.", insurerName: "MSIG", policyId: "F410191563-TRC", annualPremium: 20000 },
            { id: 2, businessLine: "IPP", nomAssurance: "MSIG Exploitation", description: "Exploitation de centrales photovoltaïques Reconstruction de la Centrale 1 an de revenus", montantGaranties: "20,000,000 € par sinistre", details: "Couvre les dommages ou pertes de revenus suite à des incidents affectant les installations en opération, assurant la continuité des opérations.", insurerName: "MSIG", policyId: "F410191563-EXP", annualPremium: 280237.6 },
            { id: 3, businessLine: "EPC", nomAssurance: "QBE Décennale", description: "Couverture de la responsabilité décennale pour la construction d'ouvrages, incluant les travaux de réparation en cas de dommages", montantGaranties: "10,000,000 € pour ouvrages soumis à assurance", details: "Nécessaire pour se conformer aux obligations légales en matière de construction, protégeant contre les coûts associés aux défauts de construction découverts après livraison.", insurerName: "QBE", policyId: "FR00100522CA22A", annualPremium: 82611.04 },
            { id: 4, businessLine: "IPP/SEED", nomAssurance: "MMA RC PRO", description: "1) Activités PEC 2) Activités O&M externes et entre HEDE & SPV 3) Prestations de DEV", montantGaranties: "10,000,000 € par sinistre", details: "Responsabilité professionnelle large : Fournit une large couverture pour les activités professionnelles, y compris en cas de fautes professionnelles ou accidents.", insurerName: "MMA", policyId: "148553843", annualPremium: 26461 },
            { id: 5, businessLine: "SEED", nomAssurance: "QBE CVC", description: "Responsabilités en tant que bureau d'études techniques en CVC, et Assistance au Maître d'Ouvrage", montantGaranties: "7,500,000 € par année d'assurance", details: "Cruciale pour les services de consultation technique et de gestion de projet, offrant une protection contre les réclamations liées à la conception et la gestion en CVC", insurerName: "QBE", policyId: "FR00100522CA22A-CVC", annualPremium: 0 },
            { id: 6, businessLine: "RC générale/Bureaux", nomAssurance: "Generali RC Exploitation", description: "Responsabilité civile liée aux activités générales de bureaux", montantGaranties: "8,000,000 € par sinistre", details: "Protège l'entreprise des réclamations de tiers pour dommages causés pendant les opérations courantes.", insurerName: "Generali", policyId: "AP986946", annualPremium: 1500 }
        ];

        // --- DOM ELEMENTS ---
        const claimsTableBody = document.getElementById('claimsTableBody'), searchInput = document.getElementById('searchInput');
        const contractsTableBody = document.getElementById('contractsTableBody'), totalPremiumEl = document.getElementById('total-premium');
        const claimModal = document.getElementById('claimModal'), modalTitle = document.getElementById('modalTitle'), modalBody = document.getElementById('modalBody'), modalFooter = document.getElementById('modalFooter');
        const contractModal = document.getElementById('contractModal'), contractModalTitle = document.getElementById('contractModalTitle'), contractModalBody = document.getElementById('contractModalBody');

        let currentSort = { column: 'dateSinistre', direction: 'desc' };
        let selectedYear = 2024;

        // --- UTILS ---
        const formatCurrency = (amount) => (amount === null || amount === undefined) ? 'N/A' : new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount);
        const formatDate = (dateString) => {
            if (!dateString || dateString === '-') return '';
            try { return new Date(dateString).toISOString().split('T')[0]; } 
            catch (e) { return ''; }
        };
        const displayDate = (dateString) => {
            if (!dateString || dateString === '-') return 'N/A';
            try {
                const date = new Date(dateString);
                date.setDate(date.getDate() + 1);
                return date.toLocaleDateString('fr-FR');
            } catch (e) { return dateString; }
        };
        const createStatusBadge = (status) => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status.toLowerCase() === 'en cours' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${status}</span>`;

        // --- RENDER FUNCTIONS ---
        const renderClaimsTable = (data) => {
            claimsTableBody.innerHTML = data.length === 0 ? `<tr><td colspan="5" class="text-center py-10 text-gray-500">Aucun sinistre trouvé.</td></tr>` : '';
            data.forEach(claim => {
                const row = claimsTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${claim.projet}</div></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${claim.spv}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate(claim.dateSinistre)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${createStatusBadge(claim.statut)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(claim.montantDevis)}</td>`;
                row.onclick = () => openClaimModal(claim.id);
            });
        };

        const renderContractsPage = () => {
            totalPremiumEl.textContent = formatCurrency(contractsData.reduce((sum, c) => sum + (c.annualPremium || 0), 0));
            contractsTableBody.innerHTML = '';
            contractsData.forEach(c => {
                const row = contractsTableBody.insertRow();
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600 hover:text-indigo-800">${c.nomAssurance}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.insurerName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.policyId}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(c.annualPremium)}</td>`;
                row.onclick = () => openContractModal(c.id);
            });
        };

        // --- APP LOGIC ---
        const filterAndRenderClaims = () => {
            const searchTerm = searchInput.value.toLowerCase();
            renderClaimsTable(claimsData.filter(claim => Object.values(claim).some(val => String(val).toLowerCase().includes(searchTerm))));
        };

        const sortClaimsTable = (column) => {
            const direction = (currentSort.column === column && currentSort.direction === 'asc') ? 'desc' : 'asc';
            claimsData.sort((a, b) => {
                let valA = a[column], valB = b[column];
                if (column.includes('date')) { valA = new Date(valA); valB = new Date(valB); }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            currentSort = { column, direction };
            renderClaimsTable(claimsData);
        };

        // --- CLAIM MODAL ---
        const openClaimModal = (claimId, isEditMode = false) => {
            const claim = claimsData.find(c => c.id === claimId);
            if (!claim) return;
            modalTitle.textContent = isEditMode ? `Édition: ${claim.projet}` : `Détails: ${claim.projet}`;
            if (isEditMode) renderClaimEditView(claim);
            else renderClaimDetailView(claim);
            claimModal.classList.add('active');
        };

        const renderClaimDetailView = (claim) => {
            modalBody.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                <div class="md:col-span-2 p-4 bg-gray-50 rounded-md"><h4 class="font-semibold text-gray-700 mb-1">Description</h4><p class="text-gray-600">${claim.sinistre}</p></div>
                <div><span class="font-semibold text-gray-500">SPV:</span> ${claim.spv}</div>
                <div><span class="font-semibold text-gray-500">Adresse:</span> ${claim.adresse}</div>
                <div><span class="font-semibold text-gray-500">Date sinistre:</span> ${displayDate(claim.dateSinistre)}</div>
                <div><span class="font-semibold text-gray-500">Statut:</span> ${createStatusBadge(claim.statut)}</div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-gray-700 mb-2">Finances</h4></div>
                <div><span class="font-semibold text-gray-500">Montant Devis:</span> ${formatCurrency(claim.montantDevis)}</div>
                <div><span class="font-semibold text-gray-500">Franchise:</span> ${formatCurrency(claim.montantFranchise)}</div>
                <div><span class="font-semibold text-gray-500">Remboursement:</span> ${formatCurrency(claim.remboursement)}</div>
                <div class="md:col-span-2 border-t pt-4 mt-2"><h4 class="font-semibold text-gray-700 mb-2">Expertise</h4></div>
                <div><span class="font-semibold text-gray-500">Expert:</span> ${claim.expert}</div>
                <div><span class="font-semibold text-gray-500">Date expertise:</span> ${displayDate(claim.dateExpertise)}</div>
                <div><span class="font-semibold text-gray-500">Réf. Assureur:</span> ${claim.refAssureur || 'N/A'}</div>
                <div class="md:col-span-2 p-4 bg-blue-50 rounded-md mt-4"><h4 class="font-semibold text-gray-700 mb-1">Suivi</h4><p class="text-gray-600">${claim.suivi || 'Aucun'}</p></div>
            </div>`;
            modalFooter.innerHTML = `<button id="editClaimBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium">Éditer le dossier</button>
                                   <button class="close-modal-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 text-sm">Fermer</button>`;
            document.getElementById('editClaimBtn').onclick = () => openClaimModal(claim.id, true);
        };

        const renderClaimEditView = (claim) => {
            modalBody.innerHTML = `<form id="editClaimForm" class="space-y-4 text-sm">
                <div class="grid md:grid-cols-2 gap-4">
                    <div><label class="block font-medium">Projet</label><input type="text" name="projet" value="${claim.projet || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                    <div><label class="block font-medium">SPV</label><input type="text" name="spv" value="${claim.spv || ''}" class="mt-1 w-full rounded-md border-gray-300 shadow-sm"></div>
                </div>
                <div><label class="block font-medium">Adresse</label><textarea name="adresse" rows="2" class="mt-1 w-full rounded-md border-gray-300 shadow-sm">${claim.adresse || ''}</textarea></div>
                <div><label class="block font-medium">Description</label><textarea name="sinistre" rows="3" class="mt-1 w-full rounded-md bord
